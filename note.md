# 重要性采样实验
## 流程拆解
```
epoch(batch) =  
    sample = 
        采样判断 
        + 随机抽样B (size = p * batch_size)
        + 划分为p个大小为b的数据集B'
        + B网络传播(分为p次) =  
            B'前向传播
            + 计算梯度上界 
        + 计算权重
        + 重要性采样b (size = batch_size)
    + train =
        b前向传播和反向传播 
    + update =
        采样阈值更新
    + callback
```
## 推断
设前向传播时间为 **t**，反向传播时间为 **T**
```
B计算时间 = Bt
b计算时间 = b(t+T)
预采样比例p：B = p*b
设 B计算时间/b计算时间 = a
令 T = k*t
则 p*bt = a*b(t+k*t)
可得 k = p/a -1 或 a = p/(1+k) 或 p = a(1+k)
```
对于一次迭代，p 为超参数；a 可以在训练中统计时间并在此次迭代后计算得到；t 和 T 与模型有关，因此 k 也可以认为是超参数，初始不可知但可在迭代后通过 p 与 a 计算得到。
```
假设忽略非模型计算时间
epoch总时间 = B计算时间 + b计算时间
引入上述参数
有 epoch = (p+1+k)*bt 
```
在训练过程中，可以调整的参数为 p 与 b 。
```
理论加速（与BGD相比）
u = 重要性采样 / BGD 
= [Bt+b(t+T)] / B(t+T)
= (p+k+1) / [p(1+k)]
```
```
理论加速（与SGD相比）
增加了计算复杂度，但提高了迭代效率
```
### 结论
提高效率的关键是**减小B(降低p)**
### 思路
1.重复利用重点样本
# 实验记录

## 实验一：重要性采样与均匀采样的对比实验
### 实验参数
cifa10数据集，ResNet网络，230服务器，3小时
### 实验结果
重要性采样：cifa10.is.3h.1.xlsx
均匀采样(SGD)：cifa10.un.3h.1.xlsx
### 关键信息
0.809151786	0.127476216	0.9199	0.378432304
0.982296445	0.202271551	0.911599999	0.49710038
### 结论
在相同训练时间下，重要性采样更优，训练集loss更低同时测试集acc更高，但提高十分有限。值得注意的是重要性采样在训练集的acc较差.

## 实验二：长训练时间的重要性采样与均匀采样的对比实验
增加训练时间，防止模型没有收敛影响结果。
### 实验参数
cifa10数据集，ResNet网络，230服务器，3小时
### 实验结果
重要性采样：cifa10.is.10h.1.xlsx
均匀采样(SGD)：cifa10.un.10h.1.xlsx
### 关键信息
0.60051306	0.081292353	0.910099983	0.394817173
0.989809783	0.168304102	0.907799999	0.502383578
### 结论
与3小时实验的结果几乎相同，对于cifa10数据集，3小时的训练已基本使模型收敛。重要性采样略微更优。重要性采样在训练集的acc较差，应该是与评估使用采样样本有关，认为此指标不具有参考性。

## 实验三：复杂数据集的重要性采样与均匀采样的对比实验
使用更加复杂的cifa100数据集，增加模型拟合难度，以表现出更加差异化的实验结果。
### 实验参数
cifa100数据集，ResNet网络，229服务器，6小时
### 实验结果
重要性采样：cifa100.is.6h.1.xlsx
均匀采样(SGD)：cifa100.un.6h.1.xlsx
### 关键信息
0.71147017	0.442952508	0.682099998	1.569312215
0.937040441	0.591849744	0.650200002	2.059556058
### 结论
与过去实验的结果几乎相同，即使对于更复杂的cifa100数据集，模型基本收敛无法表现更优。重要性采样训练集loss更低同时测试集acc更高。注意到在过去所有实验中，重要性采样次数总在50%的训练时间时发生显著改变，查看代码认为学习率影响了重要性采样。

## 实验四：固定的学习率对重要性采样的影响实验
学习率固定为0.04
### 实验参数
cifa10数据集，ResNet网络，229服务器，8小时
### 实验结果
cifa10.is.8h.lr004.xlsx
cifa10.un.8h.lr004.xlsx
### 结论
即使是固定学习率，也能够自发进行重要性采样。

## 实验五：学习率对重要性采样的影响实验
所有阶段的学习率降低一个数量级
### 实验参数
cifa10数据集，ResNet网络，229服务器，6小时
### 实验结果
cifa10.is.6h.lr_mc.xlsx
### 关键信息
学习率未改变时，能够进行重要性采样。在50%训练时间时，学习率降低，重要性采样次数降低。
### 结论
学习率确实会影响重要性采样。

## 实验六：重要性采样的时间统计实验1
从过往实验中发现，sample的时间占比较大，统计并输出两次网络传播的时间
### 实验参数
cifa10数据集，ResNet网络，229服务器，6小时
### 实验结果
cifa10.is.6h.t1.xlsx
### 关键信息
epoch时间不稳定，主要在于sample时间不稳定。但两次网络传播过程非常稳定，时间几乎不变，B的传播占比35%或70%采样时间，而b的传播占比全部训练时间。
### 结论
可能是cpu繁忙或内存的原因导致非模型计算过程时间不稳定，但本次实验表现出重要性采样过程中非模型计算时间占比较大。

## 实验七：重要性采样的时间统计实验2
与实验六相比，额外统计并输出随机抽样B的时间
### 实验参数
cifa10数据集，ResNet网络，229服务器，6小时
### 实验结果
cifa10.is.6h.t2.xlsx
### 关键信息
重要性采样过程中随机抽样B时间波动大，但能降低至很小，此时B网络传播时间几乎占比全部sample时间。<br>
两次网络传播的时间有显著的线性关系，可以认为设备因素对两次网络传播计算的影响是相同的。
### 结论
非模型计算时间在一定程度上可以忽略不计。优化重要性采样的关键是降低sample时间(B的网络传播)。

## 实验八：预采样比例对预采样计算时间的影响实验
统计在不同的预采样比例下，预采样的计算时间（B正向传播的时间）
### 实验参数
cifa10数据集，ResNet网络，229服务器，3或6小时，预采样比例presample = 3、5、7
### 实验结果
cifa10.is.3h.ps2.rnn1.xlsx
cifa10.is.6h.ps5.rnn1.xlsx
### 关键信息
训练的样本固定为128个，因此训练时间可以认为是固定的，但受到实验机器性能影响，实际多次实验中时间是不同的，故使用时间比。
在ps=2的实验中，预采样的计算时间约是训练时间的0.55
在ps=5的实验中，预采样的计算时间约是训练时间的1.25
### 结论
预采样的计算时间与预采样比例成正比，可以尝试降低预采样比例以优化重要性采样。